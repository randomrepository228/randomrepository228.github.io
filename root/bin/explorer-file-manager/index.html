<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="../../sys/windows.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <link rel="stylesheet" href="../../res/aero/style.css" id="theme">
        <meta name="viewport" content="width=device-width, initial-scale=0.6, user-scalable=no">
        <style>
            .files{
                display: flex;
                flex-wrap: wrap;
                flex-direction: row;
                overflow: auto;
                max-height: 100%;
            }
            .file{
                height: 96px;
                position: relative;
                width: 76px;
            }
            .file > p{
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                text-align: center;
                margin: 0;
                top: 48px;
                overflow: hidden;
                text-overflow: ellipsis;
                line-height: 16px;
                word-wrap: break-word;
            }
            p > marked{
                display: inline;
                background-color: rgba(255,255,0,0.5);
            }
            .file > img{
                max-width: 48px;
                max-height: 48px;
                left: 50%;
                transform: translate(-50%, -50%);
                top: 24px;
                position: absolute;
            }
        </style>
        <link rel="stylesheet" href="../control/aero/style.css" id="explorerTheme">
        <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon"> 
        <script>
            const supportedthemes = ["classic", "aero", "basic"]
            function changeTheme(a){
                theme.href = "../../res/" + a + "/style.css"
                if (!supportedthemes.includes(a)) a = supportedthemes[0]
                explorerTheme.href = "../control/" + a + "/style.css"
            }
            changeTheme(localStorage.theme)
            onmessage = (e) => {
                const commands = e.data.split("|")
                if (commands[0] == "theme" && commands.length == 2)
                    changeTheme(commands[1])
            }
        </script>
    </head>
    <body>
        <div class="navbar">
            <div class="nav"><div class="backnext"><button class="back" onclick="back()"></button><button disabled class="next"></button></div></div>
            <div class="adressbar"></div>
            <input type="text" id="searchbox" placeholder="Search in file explorer" onchange="parent.fs.searchHTML(currentPath, this.value).then(renderDir);">
        </div>
        <div class="content">
            <div class="files"></div>
        </div>
        <script>
            let thisWindow = frameElement.parentElement.parentElement.parentElement
            
            if(!parent.fs){
                parent.msgbox("Winda Explorer", "FS is not found. Turn it on in Control Panel or do a System File check")
                thisWindow.remove()
            }
            parent.showWindow("../explorer-file-manager/icon.png", thisWindow.getAttribute("windowid"));
        </script>
        <script>
            let currentPath = ""
            async function renderDir(files){
                document.querySelector(".files").innerHTML = ""
                for (a of files){
                    if (a == ".") continue
                    htmlPath = a
                    a = a.replace("<marked>", "").replace("</marked>", "")
                    let file = document.createElement("div")
                    file.className = "file"
                    let isfile = true
                    if (a.startsWith("/")) {
                        a = a.replace("/", "")
                        htmlPath = htmlPath.replace("/", "")
                    }
                    if (a.endsWith("/.")){
                        a = a.replace("/.", "")
                        htmlPath = htmlPath.replace("/.", "")
                        isfile = false
                        file.innerHTML += `<img src="folder.png">`
                        a = currentPath + "/" + a
                        file.setAttribute("ondblclick", `openFolder("${a}")`)
                    }
                    else if (a.endsWith(".png") || a.endsWith(".jpg") || a.endsWith(".gif") || a.endsWith(".bmp") || a.endsWith(".webp")){
                        let length = 3;
                        if (a.endsWith(".webp")) length = 4
                        a = currentPath + "/" + a
                        let b;
                        if(a.startsWith("/")) b = a.replace("/", "")
                        const contents = await parent.fs.readFile(b)
                        const url = URL.createObjectURL(new Blob([contents], {type: "image/" + a.substring(a.length - length, a.length)}))
                        console.log(url)
                        file.innerHTML += `<img src="${url}">`
                        file.setAttribute("ondblclick", `parent.loadApp('paint', undefined, '${a.replace("\'", "\\\'")}')`)
                    }
                    else {
                        file.innerHTML += `<img src="icon.png">`
                    }
                    file.innerHTML += "<p>" + htmlPath + "</p>"
                    document.querySelector(".files").append(file)
                }
            }
            async function openFolder(folderPath){
                currentPath = folderPath
                let folderNames = folderPath.split("/")
                document.querySelector('.adressbar').innerHTML = ""
                document.querySelector('.adressbar').innerHTML += `<div onclick="openFolder('')">/</div>`
                let path = ""
                for (a of folderPath.split("/")){
                    if(!a) continue
                    path += "/" + a
                    document.querySelector('.adressbar').innerHTML += `<div onclick="openFolder('${path}')">${a}/</div>`
                }
                let files = await parent.fs.readdir(folderPath)
                renderDir(files)
            }
            function back(){
                currentPath = ""
                openFolder("")
            }
            openFolder("")
        </script>
    </body>
</html>